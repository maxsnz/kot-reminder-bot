generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String           @id @default(uuid())
  username  String           @unique
  fullName  String?
  timezone  String? 
  createdAt DateTime         @default(now())
  chatId    Int              @unique
  schedules Schedule[]
  chatMessages ChatMessage[]
  focusId String?
  focus Focus? @relation(fields: [focusId], references: [id])
  aiRequests AiRequest[]

  // TODO: admin dashboard
  // passwordHash  String
  // role      UserRole         @default(user)
  // sessions  UserSession[]
}

// model UserSession {
//   id               String   @id @default(uuid())
//   userId           String
//   refreshTokenHash String
//   tokenHashSha    String   @unique

//   createdAt        DateTime @default(now())
//   updatedAt        DateTime @updatedAt

//   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@index([userId])
// }

// enum UserRole {
//   admin
//   user
// }

enum ScheduleKind {
  one_time
  recurring
}

enum ScheduleFrequency {
  daily
  weekly
  monthly
  yearly
}

enum StatusKind {
  active
  canceled
  ended
}

model Schedule {
  id         String           @id @default(uuid())
  user       User             @relation(fields: [userId], references: [id])
  userId     String
  message    String
  kind       ScheduleKind
  sourceText String
  summary    String           @default("")
  timeSummary String          @default("")
  actionSummary String        @default("")
  emoji      String?
  status     StatusKind       @default(active)

  // One-time scheduling
  runAtDates      String[]    @default([])
  runAtTimes      String[]    @default([])

  // Recurring scheduling
  frequency       ScheduleFrequency?
  intervalStep    Int         @default(1)
  startAtDate     String?
  endAtDate       String?
  timesOfDay      String[]    @default([])
  daysOfWeek      Int[]       @default([])
  daysOfMonth     Int[]       @default([])
  monthsOfYear    Int[]       @default([])

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  chatMessages ChatMessage[]
  focus Focus[]
}

enum MessageRole {
  user
  assistant
  system
}

model ChatMessage {
  id        String      @id @default(uuid())
  user      User        @relation(fields: [userId], references: [id])
  userId    String

  telegramChatId    String
  telegramMessageId String?
  telegramReplyToId String?

  role      MessageRole
  text      String

  aiAction  Json?

  scheduleId String?
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])

  createdAt DateTime   @default(now())

  focusId String?
  focus   Focus? @relation(fields: [focusId], references: [id])

  @@index([userId, createdAt])
  @@index([scheduleId])
}

model Focus {
  id        String      @id @default(uuid())
  createdAt DateTime   @default(now())

  scheduleId String?
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])

  chatMessages ChatMessage[]
  users User[]
}

model AiRequest {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  status        AiRequestStatus @default(queued) // queued|processing|succeeded|failed

  prompt        Json?
  responseText  String?  @db.Text
  responseJson  Json?
  error         String?  @db.Text
  elapsedTime   Int?

  // usage
  modelName     String?
  inputTokens   Int?
  outputTokens  Int?
  totalTokens   Int?
  cost          Decimal? @db.Decimal(10,6)

  createdAt     DateTime @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?

  @@index([userId, createdAt])
  @@index([status])
}

enum AiRequestStatus {
  queued
  processing
  succeeded
  failed
}

model Setting {
  key String @id
  value String

  @@index([key])
}